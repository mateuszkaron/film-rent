<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FilmRent - Wypo≈ºyczalnia Film√≥w</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
    
    <div id="auth-screen">
        <div class="auth-box">
            <h1>üé¨ FilmRent</h1>
            <h3 id="form-title">Zaloguj siƒô do swojego konta</h3>
            <input type="email" id="email" placeholder="Adres e-mail">
            <input type="password" id="password" placeholder="Has≈Ço">
            
            <div id="register-fields" class="hidden">
                <input type="text" id="fname" placeholder="Imiƒô">
                <input type="text" id="lname" placeholder="Nazwisko">
                <input type="text" id="address" placeholder="Adres zamieszkania">
                <input type="text" id="phone" placeholder="Telefon">
            </div>

            <button onclick="handleAuth()" id="main-auth-btn">Zaloguj siƒô</button>
            <p style="font-size: 0.9rem; color: var(--text-secondary); cursor: pointer; text-decoration: underline; margin-top: 25px;" onclick="toggleAuth()">
                <span id="toggle-text">Nie masz konta? Zarejestruj siƒô</span>
            </p>
            <div id="error-msg" style="color: red; margin-top: 10px;"></div>
        </div>
    </div>

    <!-- DODAWANIE UZYTKOWNIKA -->
    <div id="add-user-modal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5);">
        <div class="modal-content" style="background-color:white; margin:5% auto; padding:20px; border-radius:8px; width:90%; max-width:500px;">
            <h3 style="color:#333; margin-bottom:20px;">‚ûï Dodaj nowego u≈ºytkownika</h3>
            <form id="add-user-form">
                <input type="email" id="add-user-email" placeholder="Email" required style="width:100%; margin-bottom:10px; padding:10px; border:1px solid #ddd; border-radius:4px;">
                <input type="password" id="add-user-password" placeholder="Has≈Ço" required style="width:100%; margin-bottom:10px; padding:10px; border:1px solid #ddd; border-radius:4px;">
                <input type="text" id="add-user-firstname" placeholder="Imiƒô" required style="width:100%; margin-bottom:10px; padding:10px; border:1px solid #ddd; border-radius:4px;">
                <input type="text" id="add-user-lastname" placeholder="Nazwisko" required style="width:100%; margin-bottom:10px; padding:10px; border:1px solid #ddd; border-radius:4px;">
                <input type="text" id="add-user-address" placeholder="Adres" required style="width:100%; margin-bottom:10px; padding:10px; border:1px solid #ddd; border-radius:4px;">
                <input type="tel" id="add-user-phone" placeholder="Telefon" required style="width:100%; margin-bottom:10px; padding:10px; border:1px solid #ddd; border-radius:4px;">
                <select id="add-user-role" style="width:100%; margin-bottom:20px; padding:10px; border:1px solid #ddd; border-radius:4px;">
                    <option value="user">U≈ºytkownik</option>
                    <option value="admin">Administrator</option>
                </select>
                <div style="display:flex; gap:10px;">
                    <button type="submit" class="success" style="flex:1;">Dodaj</button>
                    <button type="button" onclick="closeAddUserModal()" class="secondary" style="flex:1;">Anuluj</button>
                </div>
            </form>
        </div>
    </div>

    <!-- EDYCJA UZYTKOWNIKA -->
    <div id="edit-user-modal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5);">
        <div class="modal-content" style="background-color:white; margin:5% auto; padding:20px; border-radius:8px; width:90%; max-width:500px;">
            <span class="close" onclick="closeEditUserModal()" style="color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer;">&times;</span>
            <h3>Edytuj u≈ºytkownika</h3>
            <form id="edit-user-form">
                <input type="hidden" id="edit-user-id">
                <div style="margin-bottom:10px;">
                    <input type="text" id="edit-first-name" placeholder="Imiƒô" style="width:100%; padding:8px; margin-bottom:8px; border:1px solid #ccc; border-radius:4px;">
                    <input type="text" id="edit-last-name" placeholder="Nazwisko" style="width:100%; padding:8px; margin-bottom:8px; border:1px solid #ccc; border-radius:4px;">
                    <input type="email" id="edit-email" placeholder="Email" style="width:100%; padding:8px; margin-bottom:8px; border:1px solid #ccc; border-radius:4px;">
                    <input type="text" id="edit-address" placeholder="Adres" style="width:100%; padding:8px; margin-bottom:8px; border:1px solid #ccc; border-radius:4px;">
                    <input type="text" id="edit-phone" placeholder="Telefon" style="width:100%; padding:8px; margin-bottom:8px; border:1px solid #ccc; border-radius:4px;">
                    <select id="edit-role" style="width:100%; padding:8px; margin-bottom:8px; border:1px solid #ccc; border-radius:4px;">
                        <option value="user">U≈ºytkownik</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                <button type="submit" style="background-color:var(--primary); color:white; padding:10px 20px; border:none; border-radius:4px; cursor:pointer; margin-right:10px;">Zapisz zmiany</button>
                <button type="button" onclick="closeEditUserModal()" style="background-color:#ccc; color:black; padding:10px 20px; border:none; border-radius:4px; cursor:pointer;">Anuluj</button>
            </form>
        </div>
    </div>

    <!-- SZCZEG√ì≈ÅY FILMU -->
    <div id="movie-details-modal" class="movie-details-modal">
        <div class="movie-details-content">
            <span class="close" onclick="closeMovieDetailsModal()" style="color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer;">&times;</span>
            <div id="movie-details-content">
                <!-- Szczeg√≥≈Çy filmu bƒôdƒÖ wstawione tutaj -->
            </div>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <header>
            <div style="display: flex; align-items: center;">
                <h2>üé¨ FilmRent</h2>
                <div style="margin-left: 30px; display: flex; align-items: center;">
                    <span style="color: var(--text-secondary); font-size: 1.1rem;">Witaj, </span>
                    <span id="user-name" style="margin-left: 8px; font-weight: 600; font-size: 1.1rem;">U≈ºytkowniku</span>
                    <span id="user-role-badge">USER</span>
                </div>
            </div>
            <div class="controls">
                <button class="secondary" onclick="logout()">Wyloguj siƒô</button>
            </div>
        </header>

        <div id="admin-panel" class="hidden">
            <h3>‚ö° Centrum Kontroli</h3>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchAdminTab('rentals')">üìä Wypo≈ºyczenia</button>
                <button class="tab-btn" onclick="switchAdminTab('users')">üë• U≈ºytkownicy</button>
                <button class="tab-btn" onclick="switchAdminTab('movies')">üçø Filmy</button>
                <button class="tab-btn" onclick="switchAdminTab('add-movie')">‚ûï Nowy Film</button>
            </div>

            <div id="adm-rentals" class="adm-tab">
                <div style="display:flex; gap:10px; margin-bottom:15px; align-items:center;">
                    <button class="small" onclick="loadAdminRentals()">Od≈õwie≈º listƒô</button>
                    <input id="rentals-search" placeholder="Szukaj (klient/email/film)..." oninput="loadAdminRentals()" style="flex:1; max-width:300px;">
                </div>
                <div style="overflow-x:auto;">
                    <table id="rentals-table">
                        <thead><tr>
                            <th style="cursor:pointer; user-select:none;" onclick="setSortRentals('user')">Klient <span id="sort-user"></span></th>
                            <th style="cursor:pointer; user-select:none;" onclick="setSortRentals('movie')">Film <span id="sort-movie"></span></th>
                            <th style="cursor:pointer; user-select:none;" onclick="setSortRentals('rented_at')">Wypo≈ºyczenie <span id="sort-rented_at"></span></th>
                            <th style="cursor:pointer; user-select:none;" onclick="setSortRentals('due_date')">Termin <span id="sort-due_date"></span></th>
                            <th>Zwr√≥cono</th>
                            <th>Akcja</th>
                        </tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="adm-users" class="adm-tab hidden">
                <div style="margin-bottom: 10px;">
                    <button class="small" onclick="loadUsers()">Od≈õwie≈º klient√≥w</button>
                    <button class="small" onclick="showAddUserModal()">Dodaj u≈ºytkownika</button>
                </div>
                <div style="overflow-x:auto;">
                    <table id="users-table">
                        <thead><tr><th>Imiƒô</th><th>Email</th><th>Adres</th><th>Telefon</th><th>Aktywne Filmy</th><th>Akcja</th></tr></thead>
                        <tbody><tr><td colspan="6">≈Åadowanie...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <div id="adm-movies" class="adm-tab hidden">
                <div style="margin-bottom: 20px;">
                    <button class="small" onclick="loadAdminMovies()">Od≈õwie≈º filmy</button>
                </div>
                <div id="admin-movies-list" class="admin-movie-list"></div>
            </div>

            <div id="adm-add-movie" class="adm-tab hidden">
                <div class="form-grid">
                    <input id="new-title" placeholder="Tytu≈Ç filmu" required>
                    <input id="new-genre" placeholder="Gatunek">
                    <input id="new-director" placeholder="Re≈ºyser">
                    <input type="number" id="new-rating" placeholder="Ocena (1-10)" min="1" max="10">
                    <input type="number" id="new-duration" placeholder="Czas trwania (minuty)" min="1">
                    <input type="number" id="new-copies" placeholder="Liczba kopii" value="5" min="1">
                </div>
                <input id="new-desc" placeholder="Opis filmu" style="margin-bottom: 15px;">
                <input id="new-actors" placeholder="Aktorzy (oddzieleni przecinkami)" style="margin-bottom: 20px;">
                <button class="success" onclick="addMovie()" data-tooltip="Dodaj nowy film do bazy danych">
                    ‚ûï Dodaj do katalogu
                </button>
            </div>
        </div>

        <!-- MENU -->
        <div id="user-navigation" class="user-nav">
            <button class="user-nav-btn active" onclick="showUserTab('movies')">üé¨ Katalog Film√≥w</button>
            <button class="user-nav-btn" onclick="showUserTab('rentals')">üìö Moje Wypo≈ºyczenia</button>
        </div>

        <div class="dashboard-grid">
            <!-- KATALOG FILM√ìW -->
            <div id="user-movies-section" class="content-section">
                <h3>üé¨ Katalog Film√≥w</h3>
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <input id="search-input" placeholder="Szukaj (Tytu≈Ç/Gatunek)..." oninput="loadMovies()">
                    <select id="sort-select" onchange="loadMovies()" style="width:150px;">
                        <option value="title">Sort: A-Z</option>
                        <option value="rating">Sort: Ocena</option>
                    </select>
                </div>
                <div id="movies-list" class="movie-list"></div>
            </div>

            <!-- HISTORIA WYPO≈ªYCZE≈É -->
            <div id="user-rentals-section" class="content-section hidden">
                <h3>üìö Historia Wypo≈ºycze≈Ñ</h3>
                <div id="user-rentals-list" class="rental-list"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const API_URL = 'https://backend-service-989611935636.europe-central2.run.app';
    let isRegister = false;

    // --- AUTH ---
    function checkLogin() {
        const token = localStorage.getItem('token');
        const role = localStorage.getItem('role'); // 'user' lub 'admin'
        
        if (token) {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('user-role-badge').innerText = role === 'admin' ? 'ADMIN' : 'KLIENT';
            
        if (role === 'admin') {
            // Admin widzi tylko panel administracyjny
            document.getElementById('admin-panel').classList.remove('hidden');
            document.getElementById('user-navigation').classList.add('hidden');
            document.getElementById('user-movies-section').classList.add('hidden');
            document.getElementById('user-rentals-section').classList.add('hidden');
            loadAdminRentals();
            setTimeout(() => { loadUsers(); loadAdminMovies(); }, 500);
        } else {
            // U≈ºytkownik widzi sekcjƒô katalogu i swojƒÖ nawigacjƒô
            document.getElementById('admin-panel').classList.add('hidden');
            document.getElementById('user-navigation').classList.remove('hidden');
            document.getElementById('user-movies-section').classList.remove('hidden');
            showUserTab('movies');
            loadMovies();
        }
        } else {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
        }
    }

    async function handleAuth() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errBox = document.getElementById('error-msg');
        
        try {
            if (isRegister) {
                const fname = document.getElementById('fname').value;
                const lname = document.getElementById('lname').value;
                const address = document.getElementById('address').value;
                const phone = document.getElementById('phone').value;

                const res = await fetch(`${API_URL}/register`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email: email, 
                        password: password,
                        first_name: fname, 
                        last_name: lname,
                        address: address,
                        phone_number: phone
                    })
                });

                if (!res.ok) throw new Error((await res.json()).detail);
                alert("Zarejestrowano! Zaloguj siƒô.");
                toggleAuth();
            } else {
                // LOGOWANIE
                const formData = new URLSearchParams();
                formData.append('username', email);
                formData.append('password', password);
                const res = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                    body: formData
                });
                if (!res.ok) throw new Error("B≈Çƒôdny login lub has≈Ço");
                const data = await res.json();
                
                localStorage.setItem('token', data.access_token);
                localStorage.setItem('role', data.role);
                checkLogin();
            }
        } catch (e) {
            errBox.innerText = e.message;
        }
    }

    function toggleAuth() {
        isRegister = !isRegister;
        document.getElementById('register-fields').classList.toggle('hidden');
        document.getElementById('form-title').innerText = isRegister ? "Rejestracja" : "Logowanie";
        document.getElementById('main-auth-btn').innerText = isRegister ? "Zarejestruj siƒô" : "Zaloguj siƒô";
        document.getElementById('toggle-text').innerText = isRegister ? "Masz konto? Zaloguj siƒô" : "Nie masz konta? Zarejestruj siƒô";
    }

    function logout() {
        localStorage.clear();
        checkLogin();
    }

    function getAuthHeaders() {
        return { 
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
        };
    }

    // --- FUNKCJE U≈ªYTKOWNIKA ---

    async function loadMovies() {
        const search = document.getElementById('search-input').value;
        const sort = document.getElementById('sort-select').value;
        
        let url = `${API_URL}/movies?sort_by=${sort}`;
        if (search) url += `&search=${search}`;

        const res = await fetch(url);
        const movies = await res.json();
        
        const container = document.getElementById('movies-list');
        const isAdmin = localStorage.getItem('role') === 'admin';
        container.innerHTML = '';
        
        movies.forEach(m => {
            const isAvail = m.available_copies > 0;
            const badge = isAvail 
                ? `<span class="badge avail">Dostƒôpne: ${m.available_copies}</span>` 
                : `<span class="badge unavail">Brak kopii</span>`;
            
            const deleteBtn = isAdmin 
                ? `<button class="danger small" style="margin-top:5px;" onclick="deleteMovie('${m._id}')">Usu≈Ñ (Admin)</button>` 
                : '';

            const duration = m.duration_minutes ? 
                `${Math.floor(m.duration_minutes / 60)}h ${m.duration_minutes % 60}min` : 
                'Brak danych';

            container.innerHTML += `
                <div class="movie-card" onclick="showMovieDetails('${m._id}')">
                    <div class="movie-card-content">
                        <h3>${m.title}</h3>
                        <div class="genre-director">${m.genre} </br> ‚Ä¢ Re≈ºyseria: ${m.director}</div>
                        <div class="rating-duration">
                            <span style="display: flex; align-items: center; gap: 5px;">
                                ‚≠ê <strong>${m.rating}/10</strong>
                            </span>
                            <span style="display: flex; align-items: center; gap: 5px;">
                                üïê <strong>${duration}</strong>
                            </span>
                        </div>
                        <p class="description">${m.description}</p>
                        <div class="card-actions" onclick="event.stopPropagation();">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                ${badge}
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <button class="small" onclick="showMovieDetails('${m._id}')">üìñ Szczeg√≥≈Çy</button>
                                <button class="small ${!isAvail ? 'secondary' : ''}" ${!isAvail ? 'disabled' : ''} onclick="rentMovie('${m._id}')">
                                    ${!isAvail ? '‚è≥ Niedostƒôpny' : '‚ñ∂Ô∏è Wypo≈ºycz'}
                                </button>
                                ${deleteBtn}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
    }

    async function rentMovie(id) {
        if(!confirm("Wypo≈ºyczyƒá film?")) return;
        const res = await fetch(`${API_URL}/rentals?movie_id=${id}`, {
            method: 'POST',
            headers: getAuthHeaders()
        });
        if (res.ok) {
            alert("Udane wypo≈ºyczenie!");
            loadMovies();
            if(localStorage.getItem('role')==='admin') loadAdminRentals();
        } else {
            const err = await res.json();
            alert("B≈ÇƒÖd: " + err.detail);
        }
    }



    // --- FUNKCJE ADMINISTRATORA ---

    function switchAdminTab(tabName) {
        console.log("Prze≈ÇƒÖczanie na zak≈Çadkƒô:", tabName);
        
        document.querySelectorAll('.adm-tab').forEach(t => t.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        const targetTab = document.getElementById(`adm-${tabName}`);
        if (targetTab) {
            targetTab.classList.remove('hidden');
        } else {
            console.error(`Nie znaleziono zak≈Çadki: adm-${tabName}`);
        }
        
        const buttons = document.querySelectorAll('.tab-btn');
        buttons.forEach(btn => {
            if (btn.textContent.includes('U≈ºytkownicy') && tabName === 'users') {
                btn.classList.add('active');
            } else if (btn.textContent.includes('Wypo≈ºyczenia') && tabName === 'rentals') {
                btn.classList.add('active');
            } else if (btn.textContent.includes('Filmy') && tabName === 'movies') {
                btn.classList.add('active');
            } else if (btn.textContent.includes('Nowy Film') && tabName === 'add-movie') {
                btn.classList.add('active');
            }
        });
        
        if(tabName === 'rentals') {
            console.log("≈Åadowanie wypo≈ºycze≈Ñ...");
            loadAdminRentals();
        }
        if(tabName === 'users') {
            console.log("≈Åadowanie u≈ºytkownik√≥w...");
            loadUsers();
        }
        if(tabName === 'movies') {
            console.log("≈Åadowanie film√≥w dla admina...");
            loadAdminMovies();
        }
    }

    let rentalSortState = { sortBy: 'rented_at', sortOrder: 'desc' };

    function setSortRentals(column) {
        if (rentalSortState.sortBy === column) {
            rentalSortState.sortOrder = rentalSortState.sortOrder === 'asc' ? 'desc' : 'asc';
        } else {
            rentalSortState.sortBy = column;
            rentalSortState.sortOrder = 'desc';
        }
        updateSortIndicators();
        loadAdminRentals();
    }

    function updateSortIndicators() {
        document.getElementById('sort-user').textContent = '';
        document.getElementById('sort-movie').textContent = '';
        document.getElementById('sort-rented_at').textContent = '';
        document.getElementById('sort-due_date').textContent = '';
        
        const indicator = rentalSortState.sortOrder === 'asc' ? '‚ñ≤' : '‚ñº';
        const columnMap = {
            'user': 'sort-user',
            'movie': 'sort-movie',
            'rented_at': 'sort-rented_at',
            'due_date': 'sort-due_date'
        };
        if (columnMap[rentalSortState.sortBy]) {
            document.getElementById(columnMap[rentalSortState.sortBy]).textContent = indicator;
        }
    }

    async function loadAdminRentals() {
        try {
            const search = document.getElementById('rentals-search')?.value || '';
            const params = new URLSearchParams({
                sort_by: rentalSortState.sortBy,
                sort_order: rentalSortState.sortOrder,
                ...(search && { search })
            });
            
            const res = await fetch(`${API_URL}/admin/rentals?${params}`, { headers: getAuthHeaders() });
            const rentals = await res.json();
            const tbody = document.querySelector('#rentals-table tbody');
            tbody.innerHTML = '';
            
            if (rentals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:#999;">Brak wypo≈ºycze≈Ñ</td></tr>';
                return;
            }
            
            rentals.forEach(r => {
                const isActive = r.returned_at === null;
                const action = isActive 
                    ? `<button class="small success" onclick="returnMovie('${r._id}')">Zwr√≥ƒá</button>` 
                    : '<span style="color:green">Oddano</span>';
                const rented = new Date(r.rented_at).toLocaleString('pl-PL');
                const due = new Date(r.due_date).toLocaleString('pl-PL');
                const returned = r.returned_at ? new Date(r.returned_at).toLocaleString('pl-PL') : '-';
                tbody.innerHTML += `
                    <tr>
                        <td><b>${r.user_fullname}</b><br><small>${r.user_email}</small></td> 
                        <td>${r.movie_title || r.movie_id}</td>
                        <td>${rented}</td>
                        <td>${due}</td>
                        <td>${returned}</td>
                        <td>${action}</td>
                    </tr>
                `;
            });
        } catch(e) {
            alert('B≈ÇƒÖd: ' + e.message);
        }
    }

    async function returnMovie(rentalId) {
        const res = await fetch(`${API_URL}/rentals/return/${rentalId}`, {
            method: 'POST',
            headers: getAuthHeaders()
        });
        if(res.ok) {
            loadAdminRentals();
            loadMovies();
        } else alert("B≈ÇƒÖd zwrotu");
    }

    async function loadUsers() {
        try {
            const res = await fetch(`${API_URL}/users`, { headers: getAuthHeaders() });
            
            // wyloguj automatycznie
            if (res.status === 401) {
                logout();
                return;
            }

            // Sprawd≈∫ czy odpowied≈∫ jest poprawna
            if (!res.ok) {
                const errorData = await res.json();
                console.error("B≈ÇƒÖd API:", errorData);
                alert(`B≈ÇƒÖd ≈Çadowania u≈ºytkownik√≥w: ${errorData.detail || 'Nieznany b≈ÇƒÖd'}`);
                return;
            }

            const users = await res.json();
            console.log("Otrzymano u≈ºytkownik√≥w:", users);
            
            if (!Array.isArray(users)) {
                console.error("Otrzymano b≈Çƒôdne dane (nie tablica):", users);
                alert("B≈ÇƒÖd: Otrzymano nieprawid≈Çowe dane z serwera");
                return;
            }

            const tbody = document.querySelector('#users-table tbody');
            if (!tbody) {
                console.error("Nie znaleziono tabeli u≈ºytkownik√≥w");
                return;
            }
            
            tbody.innerHTML = '';
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4">Brak u≈ºytkownik√≥w w bazie danych</td></tr>';
                return;
            }
            
            users.forEach(u => {
                const name = `${u.first_name || '-'} ${u.last_name || '-'}`;
                const email = u.email || 'Brak emaila';
                const role = u.role || 'user';
                const address = u.address || 'Brak adresu';
                const phone_number = u.phone_number || 'Brak numeru';
                const rentalsCount = Array.isArray(u.active_rentals) ? u.active_rentals.length : 0;
                const id = u._id || u.id; 

                tbody.innerHTML += `
                    <tr>
                        <td>${name}</td>
                        <td>${email} <small>(${role})</small></td>
                        <td>${address}</td>
                        <td>${phone_number}</td>
                        <td>${rentalsCount}</td>
                        <td>
                            <button class="small" onclick="editUser('${id}', '${u.first_name || ''}', '${u.last_name || ''}', '${email}', '${u.address || ''}', '${u.phone_number || ''}', '${role}')">Edytuj</button>
                            <button class="small danger" onclick="deleteUser('${id}')">Usu≈Ñ</button>
                        </td>
                    </tr>
                `;
            });
        } catch (err) {
            console.error("B≈ÇƒÖd w loadUsers:", err);
            alert(`B≈ÇƒÖd podczas ≈Çadowania u≈ºytkownik√≥w: ${err.message}`);
        }
    }

    async function deleteUser(id) {
        if(!confirm("UsunƒÖƒá u≈ºytkownika?")) return;
        try {
            const res = await fetch(`${API_URL}/users/${id}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });
            if(res.ok) {
                alert("U≈ºytkownik usuniƒôty pomy≈õlnie!");
                loadUsers();
            } else {
                const error = await res.json();
                alert(`B≈ÇƒÖd: ${error.detail || 'Nie uda≈Ço siƒô usunƒÖƒá u≈ºytkownika'}`);
            }
        } catch (error) {
            alert(`B≈ÇƒÖd podczas usuwania u≈ºytkownika: ${error.message}`);
        }
    }

    async function addMovie() {
        const actorsInput = document.getElementById('new-actors').value;
        const actors = actorsInput ? actorsInput.split(',').map(actor => actor.trim()).filter(actor => actor) : [];
        
        const title = document.getElementById('new-title').value.trim();
        const genre = document.getElementById('new-genre').value.trim();
        const director = document.getElementById('new-director').value.trim();
        const rating = parseFloat(document.getElementById('new-rating').value);
        const duration = parseInt(document.getElementById('new-duration').value);
        const copies = parseInt(document.getElementById('new-copies').value);
        const description = document.getElementById('new-desc').value.trim();

        // Walidacja p√≥l
        if (!title || !genre || !director || !rating || !duration || !copies || !description) {
            alert("Wszystkie pola sƒÖ wymagane!");
            return;
        }

        if (rating < 1 || rating > 10) {
            alert("Ocena musi byƒá miƒôdzy 1 a 10!");
            return;
        }

        if (duration <= 0 || copies <= 0) {
            alert("Czas trwania i liczba kopii muszƒÖ byƒá wiƒôksze od 0!");
            return;
        }

        const movieData = {
            title: title,
            genre: genre,
            director: director,
            rating: rating,
            duration_minutes: duration,
            total_copies: copies,
            available_copies: copies,
            description: description,
            actors: actors
        };

        try {
            const res = await fetch(`${API_URL}/movies`, {
                method: 'POST',
                headers: getAuthHeaders(),
                body: JSON.stringify(movieData)
            });

            if(res.ok) {
                alert("Film dodany pomy≈õlnie!");
                loadMovies();
                loadAdminMovies();
                // Wyczy≈õƒá formularz
                document.getElementById('new-title').value = '';
                document.getElementById('new-genre').value = '';
                document.getElementById('new-director').value = '';
                document.getElementById('new-rating').value = '';
                document.getElementById('new-duration').value = '';
                document.getElementById('new-copies').value = '5';
                document.getElementById('new-desc').value = '';
                document.getElementById('new-actors').value = '';
                // Przejd≈∫ do zak≈Çadki film√≥w
                switchAdminTab('movies');
            } else {
                const error = await res.json();
                alert(`B≈ÇƒÖd: ${error.detail || 'Nie uda≈Ço siƒô dodaƒá filmu'}`);
            }
        } catch (error) {
            alert(`B≈ÇƒÖd podczas dodawania filmu: ${error.message}`);
        }
    }

    async function deleteMovie(id) {
        if(!confirm("UsunƒÖƒá film?")) return;
        try {
            const res = await fetch(`${API_URL}/movies/${id}`, {
                method: 'DELETE',
                headers: getAuthHeaders()
            });
            if(res.ok) {
                alert("Film usuniƒôty pomy≈õlnie!");
                loadMovies();
                loadAdminMovies();
            } else {
                const error = await res.json();
                alert(`B≈ÇƒÖd: ${error.detail || 'Nie uda≈Ço siƒô usunƒÖƒá filmu'}`);
            }
        } catch (error) {
            alert(`B≈ÇƒÖd podczas usuwania filmu: ${error.message}`);
        }
    }

    // SZCZEG√ì≈ÅY FILMU
    async function showMovieDetails(movieId) {
        try {
            const res = await fetch(`${API_URL}/movies`);
            const movies = await res.json();
            const movie = movies.find(m => m._id === movieId);
            
            if (!movie) {
                alert('Film nie znaleziony');
                return;
            }
            
            const duration = movie.duration_minutes ? 
                `${Math.floor(movie.duration_minutes / 60)}h ${movie.duration_minutes % 60}min` : 
                'Brak danych';
            
            const actorsList = movie.actors && movie.actors.length > 0 ? 
                movie.actors.map(actor => `<span class="actor-tag">${actor}</span>`).join('') : 
                '<span style="color:#666;">Brak informacji o obsadzie</span>';
            
            const availabilityInfo = movie.available_copies > 0 ? 
                `<span style="color:green;">‚úÖ Dostƒôpne (${movie.available_copies}/${movie.total_copies})</span>` : 
                '<span style="color:red;">‚ùå Niedostƒôpne</span>';
            
            document.getElementById('movie-details-content').innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 30px; margin-top: 20px;">
                    <div style="text-align: center;">
                        <h1 style="margin: 0; font-size: 2.5rem; font-weight: 700; background: linear-gradient(135deg, var(--primary), #42a5f5); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">${movie.title}</h1>
                        <div style="margin-top: 15px; display: flex; justify-content: center; align-items: center; gap: 25px; flex-wrap: wrap;">
                            <span style="background: linear-gradient(135deg, var(--accent), #f57c00); padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; font-weight: 600;">${movie.genre}</span>
                            <span style="color: var(--text-secondary); font-size: 1.1rem;">‚≠ê <strong style="color: var(--primary);">${movie.rating}/10</strong></span>
                            <span style="color: var(--text-secondary); font-size: 1.1rem;">üïê <strong style="color: var(--primary);">${duration}</strong></span>
                            <div>${availabilityInfo}</div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(0, 229, 255, 0.05); padding: 25px; border-radius: 15px; border: 1px solid rgba(0, 229, 255, 0.1);">
                        <h3 style="margin: 0 0 15px 0; color: var(--primary); display: flex; align-items: center; gap: 10px;">
                            üé¨ <span>Informacje o filmie</span>
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                            <div>
                                <strong style="color: var(--primary);">Re≈ºyseria:</strong>
                                <div style="color: var(--text-secondary); margin-top: 5px;">${movie.director}</div>
                            </div>
                        </div>
                        <div>
                            <strong style="color: var(--primary);">Opis fabularny:</strong>
                            <p style="line-height: 1.7; margin-top: 10px; color: var(--text-secondary); text-align: justify;">${movie.description}</p>
                        </div>
                    </div>
                    
                    <div style="background: rgba(0, 229, 255, 0.05); padding: 25px; border-radius: 15px; border: 1px solid rgba(0, 229, 255, 0.1);">
                        <h3 style="margin: 0 0 20px 0; color: var(--primary); display: flex; align-items: center; gap: 10px;">
                            ‚≠ê <span>Obsada aktorska</span>
                        </h3>
                        <div class="actors-list">
                            ${actorsList}
                        </div>
                    </div>
                    
                    ${movie.available_copies > 0 ? 
                        `<div style="text-align: center; padding: 30px 0;">
                            <button onclick="rentMovieFromDetails('${movie._id}')" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 18px 40px; border: none; border-radius: 50px; cursor: pointer; font-size: 1.1rem; font-weight: 600; box-shadow: 0 10px 30px rgba(0, 229, 255, 0.3); transition: all 0.3s ease; text-transform: uppercase; letter-spacing: 0.5px;">
                                ‚ñ∂Ô∏è Wypo≈ºycz teraz
                            </button>
                        </div>` : 
                        `<div style="text-align: center; padding: 30px 0; color: var(--text-secondary);">
                            <div style="background: linear-gradient(135deg, var(--danger), #d32f2f); color: white; padding: 15px 30px; border-radius: 50px; display: inline-block; font-weight: 600;">
                                ‚è≥ Film obecnie niedostƒôpny
                            </div>
                        </div>`
                    }
                </div>
            `;
            
            document.getElementById('movie-details-modal').style.display = 'block';
        } catch (error) {
            alert('B≈ÇƒÖd podczas ≈Çadowania szczeg√≥≈Ç√≥w filmu');
            console.error(error);
        }
    }
    
    function closeMovieDetailsModal() {
        document.getElementById('movie-details-modal').style.display = 'none';
    }
    
    async function rentMovieFromDetails(movieId) {
        if (!confirm("Wypo≈ºyczyƒá film?")) return;
        
        try {
            const res = await fetch(`${API_URL}/rentals?movie_id=${movieId}`, {
                method: 'POST',
                headers: getAuthHeaders()
            });
            
            if (res.ok) {
                alert("Udane wypo≈ºyczenie!");
                closeMovieDetailsModal();
                loadMovies();
            } else {
                const error = await res.json();
                alert(`B≈ÇƒÖd: ${error.detail}`);
            }
        } catch (error) {
            alert(`B≈ÇƒÖd podczas wypo≈ºyczenia: ${error.message}`);
        }
    }

    // DODAWANIE U≈ªYTKOWNIKA
    function showAddUserModal() {
        document.getElementById('add-user-modal').style.display = 'block';
    }

    function closeAddUserModal() {
        document.getElementById('add-user-modal').style.display = 'none';
        document.getElementById('add-user-form').reset();
    }

    // FORMULARZ DODAWANIA U≈ªYTKOWNIKA
    document.getElementById('add-user-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const userData = {
            email: document.getElementById('add-user-email').value,
            password: document.getElementById('add-user-password').value,
            first_name: document.getElementById('add-user-firstname').value,
            last_name: document.getElementById('add-user-lastname').value,
            address: document.getElementById('add-user-address').value,
            phone_number: document.getElementById('add-user-phone').value
        };

        const role = document.getElementById('add-user-role').value;

        try {
            // REJESTRACJA U≈ªYTKOWNIKA
            const res = await fetch(`${API_URL}/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData)
            });

            if (res.ok) {
                const newUser = await res.json();
                
                // Je≈õli ma byƒá adminem, aktualizujemy rolƒô
                if (role === 'admin') {
                    await fetch(`${API_URL}/users/${newUser._id}`, {
                        method: 'PUT',
                        headers: {
                            ...getAuthHeaders(),
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ role: 'admin' })
                    });
                }

                alert('U≈ºytkownik zosta≈Ç dodany!');
                closeAddUserModal();
                loadUsers();
            } else {
                const error = await res.json();
                alert(`B≈ÇƒÖd: ${error.detail}`);
            }
        } catch (error) {
            alert(`B≈ÇƒÖd podczas dodawania u≈ºytkownika: ${error.message}`);
        }
    });

    // EDYCJA U≈ªYTKOWNIKA
    function editUser(id, firstName, lastName, email, address, phone, role) {
        document.getElementById('edit-user-id').value = id;
        document.getElementById('edit-first-name').value = firstName;
        document.getElementById('edit-last-name').value = lastName;
        document.getElementById('edit-email').value = email;
        document.getElementById('edit-address').value = address;
        document.getElementById('edit-phone').value = phone;
        document.getElementById('edit-role').value = role;
        document.getElementById('edit-user-modal').style.display = 'block';
    }

    function closeEditUserModal() {
        document.getElementById('edit-user-modal').style.display = 'none';
    }

    // FORMULARZ EDYCJI U≈ªYTKOWNIKA
    document.getElementById('edit-user-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const userId = document.getElementById('edit-user-id').value;
        const userData = {
            first_name: document.getElementById('edit-first-name').value,
            last_name: document.getElementById('edit-last-name').value,
            email: document.getElementById('edit-email').value,
            address: document.getElementById('edit-address').value,
            phone_number: document.getElementById('edit-phone').value,
            role: document.getElementById('edit-role').value
        };

        try {
            const res = await fetch(`${API_URL}/users/${userId}`, {
                method: 'PUT',
                headers: {
                    ...getAuthHeaders(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            });

            if (res.ok) {
                alert('U≈ºytkownik zaktualizowany pomy≈õlnie!');
                closeEditUserModal();
                loadUsers();
            } else {
                const error = await res.json();
                alert(`B≈ÇƒÖd: ${error.detail}`);
            }
        } catch (err) {
            alert(`B≈ÇƒÖd podczas aktualizacji: ${err.message}`);
        }
    });

    // MENU U≈ªYTKOWNIKA
    function showUserTab(tabName) {
        document.getElementById('user-movies-section').classList.add('hidden');
        document.getElementById('user-rentals-section').classList.add('hidden');
        
        document.querySelectorAll('.user-nav-btn').forEach(btn => btn.classList.remove('active'));
        
        if (tabName === 'movies') {
            document.getElementById('user-movies-section').classList.remove('hidden');
            document.querySelector('.user-nav-btn[onclick="showUserTab(\'movies\')"]').classList.add('active');
            loadMovies();
        } else if (tabName === 'rentals') {
            document.getElementById('user-rentals-section').classList.remove('hidden');
            document.querySelector('.user-nav-btn[onclick="showUserTab(\'rentals\')"]').classList.add('active');
            loadUserRentals();
        }
    }

    // ZA≈ÅADOWANIE WYPO≈ªYCZE≈É U≈ªYTKOWNIKA
    async function loadUserRentals() {
        try {
            const res = await fetch(`${API_URL}/my-rentals`, {
                headers: getAuthHeaders()
            });
            
            if (!res.ok) {
                throw new Error('Failed to load rentals');
            }
            
            const rentals = await res.json();
            const container = document.getElementById('user-rentals-list');
            
            if (rentals.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Brak wypo≈ºycze≈Ñ</h3>
                        <p>Nie masz jeszcze ≈ºadnych wypo≈ºyczonych film√≥w.</p>
                        <button onclick="showUserTab('movies')">Przejd≈∫ do katalogu film√≥w</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            rentals.forEach(rental => {
                const rentDate = new Date(rental.rented_at).toLocaleString('pl-PL');
                const dueDate = new Date(rental.due_date).toLocaleString('pl-PL');
                const isOverdue = new Date() > new Date(rental.due_date) && !rental.returned_at;
                const returnDate = rental.returned_at ? new Date(rental.returned_at).toLocaleString('pl-PL') : null;
                
                const statusClass = returnDate ? 'returned' : (isOverdue ? 'overdue' : 'active');
                const statusText = returnDate ? 'Zwr√≥cony' : (isOverdue ? 'Przeterminowany' : 'Aktywny');
                
                container.innerHTML += `
                    <div class="rental-card">
                        <div class="rental-info">
                            <h4>${rental.movie_title}</h4>
                            <div class="rental-details">
                                <div>üìÖ Wypo≈ºyczono: ${rentDate}</div>
                                <div>‚è∞ Termin zwrotu: ${dueDate}</div>
                                ${returnDate ? `<div>‚úÖ Zwr√≥cono: ${returnDate}</div>` : ''}
                            </div>
                        </div>
                        <div class="rental-status ${statusClass}">${statusText}</div>
                    </div>
                `;
            });
        } catch (error) {
            console.error('Error loading user rentals:', error);
            document.getElementById('user-rentals-list').innerHTML = `
                <div class="empty-state">
                    <h3>B≈ÇƒÖd ≈Çadowania</h3>
                    <p>Nie uda≈Ço siƒô za≈Çadowaƒá listy wypo≈ºycze≈Ñ.</p>
                    <button onclick="loadUserRentals()">Spr√≥buj ponownie</button>
                </div>
            `;
        }
    }

    // LADOWANIE FILM√ìW DLA ADMINA
    async function loadAdminMovies() {
        try {
            const res = await fetch(`${API_URL}/movies`);
            const movies = await res.json();
            const container = document.getElementById('admin-movies-list');
            
            container.innerHTML = '';
            movies.forEach(movie => {
                const duration = movie.duration_minutes ? 
                    `${Math.floor(movie.duration_minutes / 60)}h ${movie.duration_minutes % 60}min` : 
                    'Brak danych';
                
                container.innerHTML += `
                    <div class="admin-movie-card">
                        <h4>${movie.title}</h4>
                        <div class="movie-info">
                            <div><strong>Gatunek:</strong> ${movie.genre}</div>
                            <div><strong>Re≈ºyser:</strong> ${movie.director}</div>
                            <div><strong>Ocena:</strong> ‚≠ê ${movie.rating}/10</div>
                            <div><strong>Czas:</strong> ${duration}</div>
                            <div><strong>Dostƒôpno≈õƒá:</strong> ${movie.available_copies}/${movie.total_copies}</div>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <button class="small" onclick="showMovieDetails('${movie._id}')">üìñ Szczeg√≥≈Çy</button>
                            <button class="danger small" onclick="deleteMovie('${movie._id}')">üóëÔ∏è Usu≈Ñ</button>
                        </div>
                    </div>
                `;
            });
        } catch (error) {
            console.error('Error loading admin movies:', error);
            document.getElementById('admin-movies-list').innerHTML = `
                <div class="empty-state">
                    <h3>B≈ÇƒÖd ≈Çadowania</h3>
                    <p>Nie uda≈Ço siƒô za≈Çadowaƒá listy film√≥w.</p>
                    <button onclick="loadAdminMovies()">Spr√≥buj ponownie</button>
                </div>
            `;
        }
    }

    window.onclick = function(event) {
        const movieModal = document.getElementById('movie-details-modal');
        const editModal = document.getElementById('edit-user-modal');
        
        if (event.target === movieModal) {
            closeMovieDetailsModal();
        }
        if (event.target === editModal) {
            closeEditUserModal();
        }
    }

    checkLogin();
</script>

</body>
</html>